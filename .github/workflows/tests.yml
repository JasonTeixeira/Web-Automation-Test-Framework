name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black pylint isort mypy
          pip install -r requirements.txt
      
      - name: Run Black
        run: black --check --diff .
        continue-on-error: true
      
      - name: Run isort
        run: isort --check-only --diff .
        continue-on-error: true
      
      - name: Run Pylint
        run: pylint pages utils config tests --disable=C0111,R0913
        continue-on-error: true

  test-chromium:
    name: Tests (Chromium)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
      
      - name: Run Chromium Tests
        env:
          BROWSER: chromium
          HEADLESS: true
          CI: true
        run: |
          pytest tests/ \
            --maxfail=5 \
            -n 4 \
            --html=reports/report-chromium.html \
            --self-contained-html \
            --alluredir=reports/allure-results-chromium
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-chromium
          path: |
            reports/
            screenshots/
            logs/
          retention-days: 30
      
      - name: Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-chromium
          path: reports/allure-results-chromium
          retention-days: 30

  test-firefox:
    name: Tests (Firefox)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install firefox
      
      - name: Run Firefox Tests
        env:
          BROWSER: firefox
          HEADLESS: true
          CI: true
        run: |
          pytest tests/ \
            --maxfail=5 \
            -n 4 \
            --html=reports/report-firefox.html \
            --self-contained-html \
            --alluredir=reports/allure-results-firefox
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-firefox
          path: |
            reports/
            screenshots/
            logs/
          retention-days: 30

  test-webkit:
    name: Tests (WebKit)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install webkit
      
      - name: Run WebKit Tests
        env:
          BROWSER: webkit
          HEADLESS: true
          CI: true
        run: |
          pytest tests/ \
            --maxfail=5 \
            -n 4 \
            --html=reports/report-webkit.html \
            --self-contained-html \
            --alluredir=reports/allure-results-webkit
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-webkit
          path: |
            reports/
            screenshots/
            logs/
          retention-days: 30

  smoke-tests:
    name: Smoke Tests (Fast)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
      
      - name: Run Smoke Tests
        env:
          BROWSER: chromium
          HEADLESS: true
          CI: true
        run: |
          pytest tests/ \
            -m smoke \
            -n 4 \
            --html=reports/smoke-report.html \
            --self-contained-html
      
      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: reports/
          retention-days: 7

  generate-allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [test-chromium, test-firefox, test-webkit]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Allure Results (Chromium)
        uses: actions/download-artifact@v4
        with:
          name: allure-results-chromium
          path: allure-results
        continue-on-error: true
      
      - name: Download Allure Results (Firefox)
        uses: actions/download-artifact@v4
        with:
          name: test-results-firefox
          path: allure-results
        continue-on-error: true
      
      - name: Download Allure Results (WebKit)
        uses: actions/download-artifact@v4
        with:
          name: test-results-webkit
          path: allure-results
        continue-on-error: true
      
      - name: Get Allure history
        uses: actions/checkout@v4
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      
      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20
      
      - name: Deploy Allure Report to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [test-chromium, test-firefox, test-webkit]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Send Slack Notification
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: ${{ job.status }}
          text: |
            Tests failed on main branch!
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: '#test-results'
